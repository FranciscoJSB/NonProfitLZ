{
    "name": "esConnectivityGoalState",
    "label": "Network Connectivity and Topology",
    "subLabel": {
        "preValidation": "",
        "postValidation": ""
    },
    "bladeTitle": "lzGs",
    "elements": [
        {
            "name": "multiPlatformConnectivitySub",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
                "text": "To enable connectivity for Azure and on-premises, you must allocate a dedicated connectivity Subscription. Please note, this Subscription will be moved to the connectivity Management Group, and ARM will deploy the first hub virtual network for either a hub and spoke or Virtual WAN network topology. Additional networking platform resources such as gateways or Azure Firewall can be deployed. We recommend using a new dedicated Subscription with no existing resources. When you need to scale-out networking, either into the same region and same subscription, or to a new region or a separate connectivity subscription, use the following link to deploy and scale-out.",
                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/define-an-azure-network-topology",
                "style": "Info"
            }
        },
        {
            "name": "singlePlatformConnectivitySub",
            "type": "Microsoft.Common.InfoBox",
            "visible": false
        },
        {
            "name": "connSection",
            "type": "Microsoft.Common.Section",
            "label": "Azure Connectivity Configuration",
            "elements": [
                {
                    "name": "azMonText",
                    "type": "Microsoft.Common.TextBlock",
                    "visible": true,
                    "options": {
                        "text": "The FSI Landing Zones provides the foundational networking and connectivity services for deploying telco applications and services on Microsoft Azure at scale. Select the preferred networking topology and services for Azure and the Distributed Edge.",
                        "link": {
                            "label": "Learn more",
                            "uri": "https://github.com/microsoft/industry/blob/main/telco/docs/telco-networking.md"
                        }
                    }
                }
            ],
            "visible": true
        },
        {
            "name": "esHub",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy networking topology for Azure and on-premises",
            "defaultValue": "vhub",
            "toolTip": "Select the preferred network topology. If third-party NVA is a requirement, you must deploy this into the connectivity subscription post the deployment.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Hub and spoke (customer managed)",
                        "value": "vhub"
                    }
                ]
            },
            "visible": false
        },
        {
            "name": "esNwSubSection",
            "type": "Microsoft.Common.Section",
            "label": "Connectivity subscription",
            "elements": [
                {
                    "type": "Microsoft.Common.SubscriptionSelector",
                    "name": "esNwSub",
                    "label": "Connectivity subscription"
                }
            ],
            "visible": true
        },
        {
            "name": "esAddressHubVWAN",
            "type": "Microsoft.Common.TextBox",
            "label": "Address space (required for vWAN hub)",
            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.0.0/23)",
            "defaultValue": "10.100.0.0/23",
            "visible": true
        },
        {
            "name": "esAddressHubHS",
            "type": "Microsoft.Common.TextBox",
            "label": "Address space (required for hub virtual network)",
            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.0.0/16)",
            "defaultValue": "10.100.0.0/16",
            "visible": true
        },
        {
            "name": "esLocationsApi",
            "type": "Microsoft.Solutions.ArmApiControl",
            "request": {
                "method": "GET",
                "path": "locations?api-version=2019-11-01"
            }
        },
        {
            "name": "esNwLocation",
            "type": "Microsoft.Common.DropDown",
            "label": "Region for the first networking hub",
            "filter": true,
            "toolTip": "Select the target region for you connectivity deployment (requires you to provide a subscriptionId for connectivity)",
            "constraints": {
                "allowedValues": "[map(steps('esConnectivityGoalState').esLocationsApi.value,(item) => parse(concat('{\"label\":\"',item.displayName,'\",\"value\":\"',item.name,'\"}')))]",
                "required": true
            },
            "visible": true
        },
        {
            "name": "esVpnGw",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy VPN Gateway",
            "defaultValue": "No",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy VPN gateway",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Yes",
                        "value": "Yes"
                    },
                    {
                        "label": "No",
                        "value": "No"
                    }
                ]
            }
        },
        {
            "name": "esGwRegionalOrAz",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy zone redundant or regional VPN Gateway",
            "defaultValue": "Zone redundant (recommended)",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy Virtual Gateway to the selected region and availability zones.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Zone redundant (recommended)",
                        "value": "Zone"
                    },
                    {
                        "label": "Regional",
                        "value": "Regional"
                    }
                ]
            }
        },
        {
            "name": "esGwNoAzSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the VPN Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the VPN gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "VpnGw2",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 500 IKEv2/OpenVPN connections, aggregate throughput is 1.25 Gbps",
                        "value": "VpnGw2"
                    },
                    {
                        "label": "VpnGw3",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 1000 IKEv2/OpenVPN connections, aggregate throughput is 2.5 Gbps",
                        "value": "VpnGw3"
                    },
                    {
                        "label": "VpnGw4",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 5000 IKEv2/OpenVPN connections, aggregate throughput is 5 Gbps",
                        "value": "VpnGw4"
                    },
                    {
                        "label": "VpnGw5",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 10000 IKEv2/OpenVPN connections, aggregate throughput is 10 Gbps",
                        "value": "VpnGw5"
                    }
                ]
            }
        },
        {
            "name": "esGwAzSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the VPN Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the VPN gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "VpnGw2AZ",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 500 IKEv2/OpenVPN connections, aggregate throughput is 1.25 Gbps",
                        "value": "VpnGw2AZ"
                    },
                    {
                        "label": "VpnGw3AZ",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 1000 IKEv2/OpenVPN connections, aggregate throughput is 2.5 Gbps",
                        "value": "VpnGw3AZ"
                    },
                    {
                        "label": "VpnGw4AZ",
                        "description": "Supports BGP, max 100 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 5000 IKEv2/OpenVPN connections, aggregate throughput is 5 Gbps",
                        "value": "VpnGw4AZ"
                    },
                    {
                        "label": "VpnGw5AZ",
                        "description": "Supports BGP, max 100 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 10000 IKEv2/OpenVPN connections, aggregate throughput is 10 Gbps",
                        "value": "VpnGw5AZ"
                    }
                ]
            }
        },
        {
            "name": "esGwRegionalSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the VPN Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the VPN gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "VpnGw2",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 500 IKEv2/OpenVPN connections, aggregate throughput is 1.25 Gbps",
                        "value": "VpnGw2"
                    },
                    {
                        "label": "VpnGw3",
                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 1000 IKEv2/OpenVPN connections, aggregate throughput is 2.5 Gbps",
                        "value": "VpnGw3"
                    },
                    {
                        "label": "VpnGw4",
                        "description": "Supports BGP, max 100 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 5000 IKEv2/OpenVPN connections, aggregate throughput is 5 Gbps",
                        "value": "VpnGw4"
                    },
                    {
                        "label": "VpnGw5",
                        "description": "Supports BGP, max 100 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 10000 IKEv2/OpenVPN connections, aggregate throughput is 10 Gbps",
                        "value": "VpnGw5"
                    }
                ]
            }
        },
        {
            "name": "esVwanGwScaleUnits",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the VPN Gateway scale unit",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the VPN Gateway scale unit",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "1 scale unit",
                        "description": "Supports 500 Mbps x2",
                        "value": "1"
                    },
                    {
                        "label": "2 scale units",
                        "description": "Supports 1 Gbps x 2",
                        "value": "2"
                    },
                    {
                        "label": "3 scale units",
                        "description": "Supports 1.5 Gbps x 2",
                        "value": "3"
                    },
                    {
                        "label": "4 scale units",
                        "description": "Supports 2 Gbps x 2",
                        "value": "4"
                    },
                    {
                        "label": "5 scale units",
                        "description": "Supports 2.5 Gbps x 2",
                        "value": "5"
                    },
                    {
                        "label": "6 scale units",
                        "description": "Supports 3 Gbps x 2",
                        "value": "6"
                    },
                    {
                        "label": "7 scale units",
                        "description": "Supports 3.5 Gbps x 2",
                        "value": "7"
                    },
                    {
                        "label": "8 scale units",
                        "description": "Supports 4 Gbps x 2",
                        "value": "8"
                    },
                    {
                        "label": "9 scale units",
                        "description": "Supports 4.5 Gbps x 2",
                        "value": "9"
                    },
                    {
                        "label": "10 scale units",
                        "description": "Supports 5 Gbps x 2",
                        "value": "10"
                    },
                    {
                        "label": "11 scale units",
                        "description": "Supports 5.5 Gbps x 2",
                        "value": "11"
                    },
                    {
                        "label": "12 scale units",
                        "description": "Supports 6 Gbps x 2",
                        "value": "12"
                    },
                    {
                        "label": "13 scale units",
                        "description": "Supports 6.5 Gbps x 2",
                        "value": "13"
                    },
                    {
                        "label": "14 scale units",
                        "description": "Supports 7 Gbps x 2",
                        "value": "14"
                    },
                    {
                        "label": "15 scale units",
                        "description": "Supports 7.5 Gbps x 2",
                        "value": "15"
                    },
                    {
                        "label": "16 scale units",
                        "description": "Supports 8 Gbps x 2",
                        "value": "16"
                    },
                    {
                        "label": "17 scale units",
                        "description": "Supports 8.5 Gbps x 2",
                        "value": "17"
                    },
                    {
                        "label": "18 scale units",
                        "description": "Supports 9 Gbps x 2",
                        "value": "18"
                    },
                    {
                        "label": "19 scale units",
                        "description": "Supports 9.5 Gbps x 2",
                        "value": "19"
                    },
                    {
                        "label": "20 scale units",
                        "description": "Supports 10 Gbps x 2",
                        "value": "20"
                    }
                ]
            }
        },
        {
            "name": "esAddressVpnOrEr",
            "type": "Microsoft.Common.TextBox",
            "label": "Subnet for VPN/ExpressRoute Gateways",
            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.1.0/24)",
            "defaultValue": "10.100.1.0/24",
            "visible": true,
            "constraints": {
                "required": true,
                "validations": [
                    {
                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:/(2[0-7]))$",
                        "message": "Invalid CIDR range. The address prefix must be in the range [20,27]."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 8), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 1)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressVpnOrEr, '/')), '.'), 1))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (first octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 16), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 2)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressVpnOrEr, '/')), '.'), 2))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (second octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 24), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 3)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressVpnOrEr, '/')), '.'), 3))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (third octet)."
                    },
                    {
                        "isValid": "[lessOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), last(split(steps('esConnectivityGoalState').esAddressVpnOrEr, '/')))]",
                        "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                    }
                ]
            }
        },
        {
            "name": "esErGw",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy ExpressRoute Gateway",
            "defaultValue": "No",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy ExpressRoute gateway",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Yes",
                        "value": "Yes"
                    },
                    {
                        "label": "No",
                        "value": "No"
                    }
                ]
            }
        },
        {
            "name": "esErRegionalOrAz",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy zone redundant or regional ExpressRoute Gateway",
            "defaultValue": "Zone redundant (recommended)",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy Express Route Gateway to the selected region and availability zones.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Zone redundant (recommended)",
                        "value": "Zone"
                    },
                    {
                        "label": "Regional",
                        "value": "Regional"
                    }
                ]
            }
        },
        {
            "name": "esErAzSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the ExpressRoute Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the Express Route gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "ErGw1AZ",
                        "description": "Megabits per second 1000, packets per second 100,000, connections per second 7000, max number of circuit connections is 4",
                        "value": "ErGw1AZ"
                    },
                    {
                        "label": "ErGw2AZ",
                        "description": "Megabits per second 2000, packets per second 250,000, connections per second 14000, max number of circuit connections is 8",
                        "value": "ErGw2AZ"
                    },
                    {
                        "label": "ErGw3AZ",
                        "description": "Megabits per second 10,000, packets per second 1,000,000, connections per second 28,000, max number of circuit connections is 16",
                        "value": "ErGw3AZ"
                    }
                ]
            }
        },
        {
            "name": "esErRegionalSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the ExpressRoute Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the Express Route gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Standard",
                        "description": "Megabits per second 1000, packets per second 100,000, connections per second 7000, max number of circuit connections is 4",
                        "value": "Standard"
                    },
                    {
                        "label": "HighPerformance",
                        "description": "Megabits per second 2000, packets per second 250,000, connections per second 14000, max number of circuit connections is 8",
                        "value": "HighPerformance"
                    },
                    {
                        "label": "UltraPerformance",
                        "description": "Megabits per second 10,000, packets per second 1,000,000, connections per second 28,000, max number of circuit connections is 16",
                        "value": "UltraPerformance"
                    }
                ]
            }
        },
        {
            "name": "esErNoAzSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the ExpressRoute Gateway SKU",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the required SKU for the Express Route gateway.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Standard",
                        "description": "Megabits per second 1000, packets per second 100,000, connections per second 7000, max number of circuit connections is 4",
                        "value": "Standard"
                    },
                    {
                        "label": "HighPerformance",
                        "description": "Megabits per second 2000, packets per second 250,000, connections per second 14000, max number of circuit connections is 8",
                        "value": "HighPerformance"
                    },
                    {
                        "label": "UltraPerformance",
                        "description": "Megabits per second 10,000, packets per second 1,000,000, connections per second 28,000, max number of circuit connections is 16",
                        "value": "UltraPerformance"
                    }
                ]
            }
        },
        {
            "name": "esVwanErScaleUnits",
            "type": "Microsoft.Common.DropDown",
            "label": "Select the ExpressRoute Gateway scale unit",
            "defaultValue": "",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select the ExpressRoute Gateway scale unit",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "1 scale unit",
                        "description": "Supports 2 Gbps",
                        "value": "1"
                    },
                    {
                        "label": "2 scale units",
                        "description": "Supports 4 Gbps",
                        "value": "2"
                    },
                    {
                        "label": "3 scale units",
                        "description": "Supports 6 Gbps",
                        "value": "3"
                    },
                    {
                        "label": "4 scale units",
                        "description": "Supports 8 Gbps",
                        "value": "4"
                    },
                    {
                        "label": "5 scale units",
                        "description": "Supports 10 Gbps",
                        "value": "5"
                    },
                    {
                        "label": "6 scale units",
                        "description": "Supports 12 Gbps",
                        "value": "6"
                    },
                    {
                        "label": "7 scale units",
                        "description": "Supports 14 Gbps",
                        "value": "7"
                    },
                    {
                        "label": "8 scale units",
                        "description": "Supports 16 Gbps",
                        "value": "8"
                    },
                    {
                        "label": "9 scale units",
                        "description": "Supports 18 Gbps",
                        "value": "9"
                    },
                    {
                        "label": "10 scale units",
                        "description": "Supports 20 Gbps",
                        "value": "10"
                    }
                ]
            }
        },
        {
            "name": "esAzFw",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Deploy Azure Firewall",
            "defaultValue": "Yes (recommended)",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy Azure Firewall",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Yes (recommended)",
                        "value": "Yes"
                    },
                    {
                        "label": "No",
                        "value": "No"
                    }
                ]
            }
        },
        {
            "name": "esAzFwDns",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Azure Firewall as a DNS proxy",
            "defaultValue": "No",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will enable Azure Firewall as a DNS Proxy.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Yes",
                        "value": "Yes"
                    },
                    {
                        "label": "No",
                        "value": "No"
                    }
                ]
            }
        },
        {
            "name": "esAzFwSku",
            "type": "Microsoft.Common.DropDown",
            "label": "Select Azure Firewall tier",
            "defaultValue": "Standard",
            "multiselect": false,
            "selectAll": false,
            "filter": false,
            "multiLine": true,
            "visible": true,
            "toolTip": "Select Azure Firewall tier",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Standard",
                        "description": "Standard Azure Firewall",
                        "value": "Standard"
                    },
                    {
                        "label": "Premium",
                        "description": "Premium Azure Firewall adds support for TLS inspection, IDPS, URL filtering and web categories.",
                        "value": "Premium"
                    }
                ]
            }
        },
        {
            "name": "esFwAz",
            "type": "Microsoft.Common.DropDown",
            "label": "Select Availability Zones for the Azure Firewall",
            "defaultValue": "None",
            "multiselect": true,
            "selectAll": true,
            "filter": true,
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, ARM will deploy Azure Firewall to the selected region and availability zones.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Zone 1",
                        "value": "1"
                    },
                    {
                        "label": "Zone 2",
                        "value": "2"
                    },
                    {
                        "label": "Zone 3",
                        "value": "3"
                    }
                ]
            }
        },
        {
            "name": "esAddressFw",
            "type": "Microsoft.Common.TextBox",
            "label": "Subnet for Azure Firewall",
            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.0.0/24)",
            "defaultValue": "10.100.0.0/24",
            "visible": true,
            "constraints": {
                "required": true,
                "validations": [
                    {
                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:/(2[0-6]))$",
                        "message": "Invalid CIDR range. The address prefix must be in the range [20,26]."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 8), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 1)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFw, '/')), '.'), 1))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (first octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 16), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 2)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFw, '/')), '.'), 2))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (second octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 24), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 3)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFw, '/')), '.'), 3))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (third octet)."
                    },
                    {
                        "isValid": "[lessOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), last(split(steps('esConnectivityGoalState').esAddressFw, '/')))]",
                        "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                    }
                ]
            }
        },
        {
            "name": "esAddressFwMgmt",
            "type": "Microsoft.Common.TextBox",
            "label": "Subnet for Azure Firewall Management",
            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.0.0/24)",
            "defaultValue": "10.100.10.0/24",
            "visible": true,
            "constraints": {
                "required": true,
                "validations": [
                    {
                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:/(2[0-6]))$",
                        "message": "Invalid CIDR range. The address prefix must be in the range [20,26]."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 8), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 1)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFwMgmt, '/')), '.'), 1))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (first octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 16), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 2)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFwMgmt, '/')), '.'), 2))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (second octet)."
                    },
                    {
                        "isValid": "[if(greaterOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), 24), equals(last(take(split(first(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), '.'), 3)), last(take(split(first(split(steps('esConnectivityGoalState').esAddressFwMgmt, '/')), '.'), 3))), true)]",
                        "message": "CIDR range not within virtual network CIDR range (third octet)."
                    },
                    {
                        "isValid": "[lessOrEquals(last(split(steps('esConnectivityGoalState').esAddressHubHS, '/')), last(split(steps('esConnectivityGoalState').esAddressFwMgmt, '/')))]",
                        "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                    }
                ]
            }
        },
        {
            "name": "esBgpCommunity",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable BGP Community for the virtual network",
            "defaultValue": "No",
            "visible": true,
            "toolTip": "If 'Yes' is selected when also adding a subscription for connectivity, BGP Community will be enabled for the virtual network.",
            "constraints": {
                "allowedValues": [
                    {
                        "label": "Yes",
                        "value": "Yes"
                    },
                    {
                        "label": "No",
                        "value": "No"
                    }
                ]
            }
        },
        {
            "name": "esBgpString",
            "type": "Microsoft.Common.TextBox",
            "label": "Provide the BGP Community string",
            "toolTip": "The community string must start with '12076:'. You can set a community value between 20000 and 49999",
            "defaultValue": "12076:20000",
            "visible": true,
            "constraints": {
                "required": true,
                "validations": []
            }
        },
        {
            "name": "nwSecurity",
            "type": "Microsoft.Common.Section",
            "label": "Network Security and Monitoring",
            "elements": [
                {
                    "name": "monitoring",
                    "type": "Microsoft.Common.TextBlock",
                    "visible": true,
                    "options": {
                        "text": "Select which Azure Network Security and Monitoring solutions you will enable for your platform and landing zones",
                        "link": {
                            "label": "Learn more",
                            "uri": "https://docs.microsoft.com/azure/azure-monitor/insights/solutions"
                        }
                    }
                },
                {
                    "name": "esDdoS",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Enable DDoS Protection",
                    "defaultValue": "Yes, DDoS Network Protection (recommended)",
                    "visible": true,
                    "toolTip": "If 'Yes' is selected when also adding a connectivity subscription, DDoS Network Protection will be enabled and protect your Azure resources from denial of service threats.",
                    "constraints": {
                        "allowedValues": [
                            {
                                "label": "Yes, DDoS Network Protection (recommended)",
                                "value": "Yes"
                            },
                            {
                                "label": "Yes, DDoS Network Protection per individual public IP addresses",
                                "value": "Pip"
                            },
                            {
                                "label": "No",
                                "value": "No"
                            }
                        ]
                    }
                },
                {
                    "name": "esNetworkWatcher",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Enable Network Watcher observability",
                    "defaultValue": "Yes (recommended)",
                    "visible": true,
                    "toolTip": "If 'Yes' is selected when also adding a connectivity subscription, Network Watcher will be enabled for all virtual networks for the platform and the landing zones.",
                    "constraints": {
                        "allowedValues": [
                            {
                                "label": "Yes (recommended)",
                                "value": "Yes"
                            },
                            {
                                "label": "No",
                                "value": "No"
                            }
                        ]
                    }
                },
                {
                    "name": "esNsgFlowLogs",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Enable NSG Flow Logs and Traffic Analytics",
                    "defaultValue": "Yes (recommended)",
                    "visible": true,
                    "toolTip": "If 'Yes' is selected when also adding a connectivity subscription, NSG Flow Logs will be enabled for all NSGs for the platform and the landing zones.",
                    "constraints": {
                        "allowedValues": [
                            {
                                "label": "Yes (recommended)",
                                "value": "Yes"
                            },
                            {
                                "label": "No",
                                "value": "No"
                            }
                        ]
                    }
                }
            ],
            "visible": true
        }
    ]
}
