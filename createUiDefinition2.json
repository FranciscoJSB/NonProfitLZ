{
    "$schema": "<relative path to createFormUI.schema.json>",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "FSI Landing Zones on Microsoft Azure",
            "isWizard": false,
            "steps": [
                {
                    "name": "basics",
                    "label": "Deployment location",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope"
                        }
                    ]
                },
                {
                    "name": "lzSettings",
                    "label": "Management Group and Subscription Organization",
                    "subLabel": {
                        "preValidation": "Provide a prefix for the management group structure that will be created.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "Company prefix",
                    "elements": [
                        {
                            "name": "info",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "FSI Landing Zones requires access at the tenant root (/) scope. Visit this link to ensure you have the appropriate RBAC permission to complete the deployment",
                                "uri": "https://docs.microsoft.com/azure/role-based-access-control/elevate-access-global-admin",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "mgSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Management Groups",
                            "elements": [
                                {
                                    "name": "mgmtGroup",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "FSI Landing Zones will create the management group hierarchy under the Tenant Root Group with the prefix provided at this step, which will be used to establish a proven architecture for subscription organization and policy driven governance at scale.",
                                        "link": {
                                            "label": "Learn more",
                                            "uri": "https://github.com/microsoft/industry/tree/main/fsi#fsi-landing-zones-on-microsoft-azure"
                                        }
                                    }
                                },
                                {
                                    "name": "esMgmtGroup",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Management Group prefix",
                                    "toolTip": "Provide a prefix (max 10 characters, unique at tenant-scope) for the Management Group hierarchy and other resources created as part of FSI Landing Zones.",
                                    "defaultValue": "",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,10}$",
                                        "validationMessage": "The prefix must be 1-10 characters."
                                    }
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "rpRegistrationApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "POST",
                                "path": "[concat('/providers/Microsoft.Management/managementGroups/',steps('basics').resourceScope.tenant.tenantId, '/providers/Microsoft.PolicyInsights/register?api-version=2021-04-01')]"
                            }
                        },
                        {
                            "name": "subSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Subscription Organization",
                            "elements": [
                                {
                                    "name": "subOrg",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "FSI Landing Zones recommends dedidated subscriptions for the Azure platform functionality, such as Security, Governance, Compliance, Network Connectivity, and Identity and Access. This enables the organization to scale the Azure platform and the workloads in the landing zones independently regardless of future scale-point.",
                                        "link": {
                                            "label": "Learn more",
                                            "uri": "https://github.com/microsoft/industry/blob/main/fsi/docs/architectureAndDesign.md#architecture-and-design"
                                        }
                                    }
                                },
                                {
                                    "name": "subOrgsOption",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Select dedicated subscriptions or a single subscription for FSI Landing Zones platform resources",
                                    "defaultValue": "Dedicated (recommended)",
                                    "toolTip": "Dedicated subscriptions will require separate Azure subscriptions for platform resources and is the recommended option for production environments. The single subscription option will deploy all platform resources on a single subscription.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Dedicated (recommended)",
                                                "value": "Dedicated"
                                            },
                                            {
                                                "label": "Single",
                                                "value": "Single"
                                            }
                                        ]
                                    },
                                    "visible": true
                                }
                            ],
                            "visible": false
                        },
                        {
                            "name": "esSingleSubSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Single platform subscription",
                            "elements": [
                                {
                                    "name": "subWarning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "icon": "Warning",
                                        "text": "Dedicated subscriptions are recommended for the various platform components to ensure scale, sustainability, and segregation of duties, and especially around networking. However, a single subscription can also be used in case this is not a concern (e.g., small organizations, or testing purposes).",
                                        "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-group-and-subscription-organization"
                                    }
                                },
                                {
                                    "name": "singleSubText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Select the single subscription that will be used for all platform resources during deployment, for security, logging, connectivity, and identity."
                                    }
                                },
                                {
                                    "type": "Microsoft.Common.SubscriptionSelector",
                                    "name": "esSingleSub",
                                    "label": "Single platform subscription"
                                }
                            ],
                            "visible": "[equals(steps('lzSettings').subSection.subOrgsOption, 'Single')]"
                        }
                    ]
                },
                {
                    "name": "esGoalState",
                    "label": "IMC-Hub Subscription Deployment",
                    "subLabel": {
                        "preValidation": "",
                        "postValidation": ""
                    },
                    "bladeTitle": "lzGs",
                    "elements": [
                        {
                            "name": "multiPlatformMgmtSub",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[not(equals(steps('lzSettings').subSection.subOrgsOption, 'Single'))]",
                            "options": {
                                "text": "To enable platform management and monitoring, you must allocate a dedicated Azure Subscription. Please note, this Subscription will be moved to the platform Management Group, and ARM will deploy a Log Analytics workspace and requisite settings. We recommend using a new Subscription with no existing resources. Note that Azure Policy will be used to govern the configuration for the platform at scale.",
                                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-and-monitoring",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "singlePlatformMgmtSub",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[equals(steps('lzSettings').subSection.subOrgsOption, 'Single')]",
                            "options": {
                                "text": "To enable management and monitoring, you can configure core infra such as Log Analytics and additional monitoring solutions to your dedicated platform subscription. Note that Azure Policy will be used to govern the configuration for the platform at scale.",
                                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-and-monitoring",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "azMonSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Azure Monitor",
                            "elements": [
                                {
                                    "name": "azMonText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Azure Monitor with Log Analytics provides the core infrastructure to enable platform observability, security, and log retention for the FSI Landing Zones. You can create a dedicated Log Analytics workspace and enable curated analytical solutions, that will also intersect with Microsoft Defender for Cloud and Microsoft Sentinel.",
                                        "link": {
                                            "label": "Learn more",
                                            "uri": "https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview"
                                        }
                                    }
                                },
                                {
                                    "name": "esLogAnalytics",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Deploy Log Analytics workspace and enable monitoring for your platform and resources",
                                    "defaultValue": "Yes (recommended)",
                                    "toolTip": "If 'Yes' is selected when also adding a subscription for management, Log Analytics workspace will be created in the dedicated subscription and enable additional configuration options in the deployment wizard.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Yes (recommended)",
                                                "value": "Yes"
                                            },
                                            {
                                                "label": "No",
                                                "value": "No"
                                            }
                                        ]
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "esLogRetention",
                                    "type": "Microsoft.Common.Slider",
                                    "min": 30,
                                    "max": 730,
                                    "label": "Log Analytics Data Retention (days)",
                                    "subLabel": "Days",
                                    "defaultValue": 30,
                                    "showStepMarkers": false,
                                    "toolTip": "Select retention days for Azure logs. Default is 30 days. If longer retention is required, you can optionally configure Log Analytics data export to a Storage Account or an Event Hub namespace.",
                                    "constraints": {
                                        "required": false
                                    },
                                    "visible": "[equals(steps('esGoalState').azMonSection.esLogAnalytics,'Yes')]"
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "esMgmtSubSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Management subscription",
                            "elements": [
                                {
                                    "type": "Microsoft.Common.SubscriptionSelector",
                                    "name": "esMgmtSub",
                                    "label": "Management subscription"
                                }
                            ],
                            "visible": true
                        },


                        
                        {
                            "name": "connSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Azure Connectivity Configuration",
                            "elements": [],
                            "visible": true
                        },
                        {
                            "name": "esAddressHubHS",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Address space (required for hub virtual network)",
                            "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.0.0/16)",
                            "defaultValue": "10.100.0.0/16",
                            "visible": true,
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:/(1[0-9]|2[0-4]))$",
                                        "message": "Invalid CIDR range. The address prefix must be in the range [10,24]."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "esLocationsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "locations?api-version=2019-11-01"
                            }
                        },
                        {
                            "name": "esNwLocation",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Region for the first networking hub",
                            "filter": true,
                            "toolTip": "Select the target region for you connectivity deployment (requires you to provide a subscriptionId for connectivity)",
                            "constraints": {
                                "allowedValues": "[map(steps('esGoalState').esLocationsApi.value,(item) => parse(concat('{\"label\":\"',item.displayName,'\",\"value\":\"',item.name,'\"}')))]",
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "esVpnGw",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Deploy VPN Gateway",
                            "defaultValue": "No",
                            "visible": true,
                            "toolTip": "If 'Yes' is selected ARM will deploy VPN gateway",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "Yes",
                                        "value": "Yes"
                                    },
                                    {
                                        "label": "No",
                                        "value": "No"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "esGwNoAzSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Select the VPN Gateway SKU",
                            "defaultValue": "",
                            "multiselect": false,
                            "selectAll": false,
                            "filter": false,
                            "multiLine": true,
                            "visible": true,
                            "toolTip": "Select the required SKU for the VPN gateway.",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "VpnGw1",
                                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 250 IKEv2/OpenVPN connections, aggregate throughput is 650 Mbps",
                                        "value": "VpnGw1"
                                    },
                                    {
                                        "name": "esGwRegionalSku",
                                        "type": "Microsoft.Common.DropDown",
                                        "label": "Select the VPN Gateway SKU",
                                        "defaultValue": "",
                                        "multiselect": false,
                                        "selectAll": false,
                                        "filter": false,
                                        "multiLine": true,
                                        "visible": true,
                                        "toolTip": "Select the required SKU for the VPN gateway.",
                                        "constraints": {
                                            "allowedValues": [
                                                {
                                                    "label": "VpnGw1",
                                                    "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, max 250 IKEv2/OpenVPN connections, aggregate throughput is 650 Mbps",
                                                    "value": "VpnGw1"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "name": "esAddressVpnOrEr",
                                        "type": "Microsoft.Common.TextBox",
                                        "label": "Subnet for VPN/ExpressRoute Gateways",
                                        "toolTip": "Provide address prefix in CIDR notation (e.g 10.100.1.0/24)",
                                        "defaultValue": "10.100.1.0/24",
                                        "visible": "[equals(steps('esGoalState').esVpnGw, 'Yes')]",
                                        "constraints": {
                                            "required": true,
                                            "validations": [
                                                {
                                                    "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:/(2[0-7]))$",
                                                    "message": "Invalid CIDR range. The address prefix must be in the range [20,27]."
                                                },
                                                {
                                                    "isValid": "[if(greaterOrEquals(last(split(steps('esGoalState').esAddressHubHS, '/')), 8), equals(last(take(split(first(split(steps('esGoalState').esAddressHubHS, '/')), '.'), 1)), last(take(split(first(split(steps('esGoalState').esAddressVpnOrEr, '/')), '.'), 1))), true)]",
                                                    "message": "CIDR range not within virtual network CIDR range (first octet)."
                                                },
                                                {
                                                    "isValid": "[if(greaterOrEquals(last(split(steps('esGoalState').esAddressHubHS, '/')), 16), equals(last(take(split(first(split(steps('esGoalState').esAddressHubHS, '/')), '.'), 2)), last(take(split(first(split(steps('esGoalState').esAddressVpnOrEr, '/')), '.'), 2))), true)]",
                                                    "message": "CIDR range not within virtual network CIDR range (second octet)."
                                                },
                                                {
                                                    "isValid": "[if(greaterOrEquals(last(split(steps('esGoalState').esAddressHubHS, '/')), 24), equals(last(take(split(first(split(steps('esGoalState').esAddressHubHS, '/')), '.'), 3)), last(take(split(first(split(steps('esGoalState').esAddressVpnOrEr, '/')), '.'), 3))), true)]",
                                                    "message": "CIDR range not within virtual network CIDR range (third octet)."
                                                },
                                                {
                                                    "isValid": "[lessOrEquals(last(split(steps('esGoalState').esAddressHubHS, '/')), last(split(steps('esGoalState').esAddressVpnOrEr, '/')))]",
                                                    "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "name": "nwSecurity",
                                        "type": "Microsoft.Common.Section",
                                        "label": "Network Security and Monitoring",
                                        "elements": [
                                            {
                                                "name": "monitoring",
                                                "type": "Microsoft.Common.TextBlock",
                                                "visible": true,
                                                "options": {
                                                    "text": "Select which Azure Network Security and Monitoring solutions you will enable for your platform and landing zones"
                                                }
                                            },
                                            {
                                                "name": "esDdoS",
                                                "type": "Microsoft.Common.OptionsGroup",
                                                "label": "Enable DDoS Protection",
                                                "defaultValue": "Yes, DDoS Network Protection (recommended)",
                                                "visible": true,
                                                "toolTip": "If 'Yes' is selected when also adding a connectivity subscription, DDoS Network Protection will be enabled and protect your Azure resources from denial of service threats.",
                                                "constraints": {
                                                    "allowedValues": [
                                                        {
                                                            "label": "Yes, DDoS Network Protection (recommended)",
                                                            "value": "Yes"
                                                        },
                                                        {
                                                            "label": "No",
                                                            "value": "No"
                                                        }
                                                    ]
                                                }
                                            }
                                        ],
                                        "visible": true
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "esGoalState",
                    "label": "Landing Zone Deployment",
                    "subLabel": {
                        "preValidation": "",
                        "postValidation": ""
                    },
                    "bladeTitle": "lzGs",
                    "elements": [
                        {
                            "name": "multiPlatformConnectivitySub",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[not(equals(steps('lzSettings').subSection.subOrgsOption, 'Single'))]",
                            "options": {
                                "text": "To enable connectivity for Azure and on-premises, you must allocate a dedicated connectivity Subscription. Please note, this Subscription will be moved to the connectivity Management Group, and ARM will deploy the first hub virtual network for either a hub and spoke or Virtual WAN  network topology. Additional networking platform resources such as gateways or Azure Firewall can be deployed. We recommend using a new dedicated Subscription with no existing resources. When you need to scale-out networking, either into the same region and same subscription, or to a new region or a separate connectivity subscription, use the following link to deploy and scale-out.",
                                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/define-an-azure-network-topology",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "singlePlatformConnectivitySub",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[equals(steps('lzSettings').subSection.subOrgsOption, 'Single')]",
                            "options": {
                                "text": "To enable network topology and connectivity for Azure and on-premises, you can select the preferred networking topology, and deploy this into the dedicated platform subscription. Additional networking platform resources such as gateways or Azure Firewall can also be deployed.",
                                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/define-an-azure-network-topology",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "connSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Azure Connectivity Configuration",
                            "elements": [
                                {
                                    "name": "azMonText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "The FSI Landing Zones provides the foundational networking and connectivity services for deploying telco applications and services on Microsoft Azure at scale. Select the preferred networking topology and services for Azure and the Distributed Edge.",
                                        "link": {
                                            "label": "Learn more",
                                            "uri": "https://github.com/microsoft/industry/blob/main/telco/docs/telco-networking.md"
                                        }
                                    }
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "esNwSubSection",
                            "type": "Microsoft.Common.Section",
                            "label": "Connectivity subscription",
                            "elements": [
                                {
                                    "type": "Microsoft.Common.SubscriptionSelector",
                                    "name": "esNwSub",
                                    "label": "Connectivity subscription"
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "esLocationsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "locations?api-version=2019-11-01"
                            }
                        },
                        {
                            "name": "esNwLocation",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Region for the first networking hub",
                            "filter": true,
                            "toolTip": "Select the target region for you connectivity deployment (requires you to provide a subscriptionId for connectivity)",
                            "constraints": {
                                "allowedValues": "[map(steps('esGoalState').esLocationsApi.value,(item) => parse(concat('{\"label\":\"',item.displayName,'\",\"value\":\"',item.name,'\"}')))]",
                                "required": true
                            },
                            "visible": true
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "parameters": {
                "industry": "fsi",
                "connectivitySubscriptionId": "[if(not(equals(steps('esGoalState').esNwSubSection.esNwSub.subscriptionId,steps('esGoalState').esMgmtSubSection.esMgmtSub.subscriptionId)),steps('esGoalState').esNwSubSection.esNwSub.subscriptionId,'')]",
                "managementSubscriptionId": "[steps('esGoalState').esMgmtSubSection.esMgmtSub.subscriptionId]",
                "enableLogAnalytics": "[steps('esGoalState').azMonSection.esLogAnalytics]",
                "industryPrefix": "[steps('lzSettings').mgSection.esMgmtGroup]",
                "retentionInDays": "[string(steps('esGoalState').azMonSection.esLogRetention)]",
                "location": "[steps('esGoalState').esNwLocation]",
                "enableVpnGw": "[steps('esGoalState').esVpnGw]",
                "enableDdoS": "[steps('esGoalState').nwSecurity.esDdoS]",
                "addressPrefix": "[coalesce(steps('esGoalState').esAddressHubVWAN, steps('esGoalState').esAddressHubHS, '')]",
                "gwRegionalSku": "[if(empty(steps('esGoalState').esGwRegionalSku), steps('esGoalState').esGwNoAzSku, steps('esGoalState').esGwRegionalSku)]",
                "subnetMaskForGw": "[steps('esGoalState').esAddressVpnOrEr]"
            },
            "kind": "Tenant",
            "location": "[steps('basics').resourceScope.location.name]"
        }
    }
}
